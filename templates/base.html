{% extends "base.html" %}

{% block title %}Analytics - RealEstate CRM{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Analytics</h1>
        <p>Advanced analytics and insights for data-driven decisions</p>
    </div>
</div>

<div class="charts-grid">
    <div class="card">
        <div class="card-header">
            <h3>Leads by Source</h3>
        </div>
        <div class="card-body">
            <canvas id="sourceBarChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>Leads by Priority</h3>
        </div>
        <div class="card-body">
            <canvas id="priorityPieChart"></canvas>
        </div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
            <h3>Lead Growth Trend</h3>
        </div>
        <div class="card-body">
            <canvas id="trendLineChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadAnalytics() {
    try {
        const [sourceRes, priorityRes, trendRes] = await Promise.all([
            apiRequest('/api/analytics/leads-by-source'),
            apiRequest('/api/analytics/leads-by-priority'),
            apiRequest('/api/analytics/leads-trend')
        ]);
        
        renderSourceChart(sourceRes.data || []);
        renderPriorityChart(priorityRes.data || []);
        renderTrendChart(trendRes.data || []);
    } catch (error) {
        console.error('Error loading analytics:', error);
        showToast('Failed to load analytics', 'error');
    }
}

function renderSourceChart(data) {
    const ctx = document.getElementById('sourceBarChart');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d.source),
            datasets: [{
                label: 'Number of Leads',
                data: data.map(d => d.count),
                backgroundColor: '#1d4ed8',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function renderPriorityChart(data) {
    const ctx = document.getElementById('priorityPieChart');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(d => d.priority),
            datasets: [{
                data: data.map(d => d.count),
                backgroundColor: ['#dc2626', '#f59e0b', '#64748b']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function renderTrendChart(data) {
    const ctx = document.getElementById('trendLineChart');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.month),
            datasets: [{
                label: 'Leads Created',
                data: data.map(d => d.count),
                borderColor: '#1d4ed8',
                backgroundColor: 'rgba(29, 78, 216, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: '#1d4ed8'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', loadAnalytics);
</script>
{% endblock %}
