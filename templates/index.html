<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CRM Platform - Home{% endblock %}</title>

<!-- base stylesheet -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">

<!-- per-page extra head if needed -->
{% block extra_head %}{% endblock %}

</head>
<body>
    <div class="app-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span class="logo-text">Vedaa</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <span class="nav-section-title"></span>
                <a href="{{ url_for('index') }}" class="nav-item {% if active == 'home' %}active{% endif %}">
                    <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span class="nav-text">Home</span>
                </a>
                <a href="{{ url_for('dashboard') }}" class="nav-item {% if active == 'dashboard' %}active{% endif %}">
                    <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span class="nav-text">Dashboard</span>
                    <span class="nav-badge">New</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Sales</span>
                <a href="{{ url_for('leads') }}" class="nav-item {% if active == 'leads' %}active{% endif %}">
                    <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span class="nav-text">Leads</span>
                    <span class="nav-count"></span>
                </a>
                <a href="{{ url_for('pipeline') }}" class="nav-item {% if active == 'pipeline' %}active{% endif %}">
                    <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"></line>
                        <line x1="8" y1="12" x2="21" y2="12"></line>
                        <line x1="8" y1="18" x2="21" y2="18"></line>
                        <line x1="3" y1="6" x2="3.01" y2="6"></line>
                        <line x1="3" y1="12" x2="3.01" y2="12"></line>
                        <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                    <span class="nav-text">Pipeline</span>
                    <span class="nav-count"></span>
                </a>
                <a href="{{ url_for('customers') }}" class="nav-item {% if active == 'customers' %}active{% endif %}">
                    <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <polyline points="17 11 19 13 23 9"></polyline>
                    </svg>
                    <span class="nav-text">Customers</span>
                </a>
            </div> 

            <div class="nav-section"> 
                <span class="nav-section-title">Analytics</span>
                <a href="{{ url_for('reports') }}" class="nav-item {% if active == 'reports' %}active{% endif %}">
                    <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="20" x2="12" y2="10"></line>
                        <line x1="18" y1="20" x2="18" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="16"></line>
                    </svg>
                    <span class="nav-text">Reports</span>
                </a>
                <a href="{{ url_for('analytics') }}" class="nav-item {% if active == 'analytics' %}active{% endif %}">
                    <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                    <span class="nav-text">Analytics</span>
                </a>
            </div>

            <!-- Add Settings section for admin only -->
            {% if session.get('role') == 'admin' %}
            <div class="nav-section">
                <span class="nav-section-title">Administration</span>
                <a href="{{ url_for('settings') }}" class="nav-item {% if active == 'settings' %}active{% endif %}">
                    <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m2.12 2.12l4.24 4.24m1.78 7.78l-4.24-4.24m2.12-2.12L4.22 4.22"></path>
                    </svg>
                    <span class="nav-text">Settings</span>
                </a>
            </div>
            {% endif %}
        </nav>

        <div class="sidebar-footer">
            <!-- Updated to show actual admin profile info instead of dropdown menu -->
            <div class="user-profile-card" id="userProfileCard">
                <div class="profile-avatar" id="userAvatar">
                    <span id="userInitials"></span>
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="userName"></div>
                    <div class="profile-role" id="userRole"></div>
                </div>
                <!-- Added logout button that appears on hover -->
                <button class="profile-logout-btn" onclick="logout()" title="Logout">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="main-wrapper">
        <!-- Top Bar -->
        <header class="topbar">
            <div class="topbar-left">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="search-bar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" placeholder="Search leads, customers, deals...">
                </div>
            </div>
            <div class="topbar-right">
                <!-- Notification bell with dropdown -->
                <button class="topbar-btn" id="notificationBell" onclick="toggleNotificationDropdown()" style="position: relative;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span class="notification-dot" id="notificationDot" style="display: none;"></span>
                </button>
                <!-- Notification dropdown menu -->
                <div class="notification-dropdown" id="notificationDropdown" style="display: none; position: absolute; top: 60px; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 350px; max-height: 400px; overflow-y: auto; z-index: 1000;">
                    <div style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-weight: 600; color: #1e293b;">Notifications</div>
                    <div id="notificationList" style="max-height: 340px; overflow-y: auto;">
                        <div style="padding: 20px; text-align: center; color: #94a3b8;">No notifications yet</div>
                    </div>
                </div>
                <!-- END notification bell -->
                <button class="topbar-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                </button>
                {% if session.get('role') == 'admin' %}
                <button class="btn-primary" onclick="location.href='{{ url_for('leads') }}'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Lead
                </button>
                {% endif %}
            </div>
        </header>

        <!-- Page Content: this block can be replaced by child templates -->
        <main class="page-content">
            {% block content %}
            <!-- Hero Section -->
            <section class="hero-section">
                <div class="hero-content">
                    <h1 class="hero-title">Welcome to Vedaa Command Center</h1>
                    <p class="hero-subtitle">Manage your sales pipeline, track leads, and close deals faster than ever before</p>
                    <div class="hero-actions">
                        {% if session.get('role') == 'admin' %}
                        <button class="btn-hero primary" onclick="location.href='{{ url_for('leads') }}'">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add New Lead
                        </button>
                        <button class="btn-hero secondary" onclick="location.href='{{ url_for('dashboard') }}'">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            View Dashboard
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="hero-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalLeadsValue">-</div>
                        <div class="stat-label">Total Leads</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-value" id="conversionRateValue">-</div>
                        <div class="stat-label">Conversion</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeDealsValue">-</div>
                        <div class="stat-label">Active Deals</div>
                    </div>
                </div>
            </section>

            <!-- Quick Access Cards -->
            <section class="quick-access">
                <h2 class="section-title">Quick Access</h2>
                <div class="cards-grid">
                    {% if session.get('role') == 'admin' %}
                    <div class="access-card" onclick="location.href='{{ url_for('dashboard') }}'">
                        <div class="card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3>Analytics Dashboard</h3>
                            <p>View comprehensive sales analytics, and performance metrics</p>
                            <div class="card-meta">
                                <span class="meta-badge">Updated 5m ago</span>
                            </div>
                        </div>
                        <div class="card-arrow">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        </div>
                    </div>
                    {% endif %}

                    <div class="access-card" onclick="location.href='{{ url_for('leads') }}'">
                        <div class="card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3>Lead Management</h3>
                            <p>Organize, filter, and manage all your leads in one centralized location</p>
                            <div class="card-meta">
                                <span class="meta-badge">124 active leads</span>
                            </div>
                        </div>
                        <div class="card-arrow">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        </div>
                    </div>

                    {% if session.get('role') == 'admin' %}
                    <div class="access-card" onclick="location.href='{{ url_for('pipeline') }}'">
                        <div class="card-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3>Sales Pipeline</h3>
                            <p>Track deals through every stage from prospect to closed won</p>
                            <div class="card-meta">
                                <span class="meta-badge">47 deals in progress</span>
                            </div>
                        </div>
                        <div class="card-arrow">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        </div>
                    </div>
                    {% endif %}

                    {% if session.get('role') == 'admin' %}
                    <div class="access-card">
                        <div class="card-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <line x1="12" y1="20" x2="12" y2="10"></line>
                                <line x1="18" y1="20" x2="18" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="16"></line>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3>Reports & Analytics</h3>
                            <p>Generate detailed reports and insights on your sales performance</p>
                            <div class="card-meta">
                                <span class="meta-badge">Coming soon</span>
                            </div>
                        </div>
                        <div class="card-arrow">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="activity-section">
                <div class="activity-container">
                    <div class="activity-header">
                        <h2 class="section-title">Recent Activity</h2>
                        <button class="btn-text">View All</button>
                    </div>
                    <div class="activity-timeline" id="activityTimeline">
                        <div style="text-align: center; padding: 20px; color: #999;">Loading activities...</div>
                    </div>
                </div>
            </section>
            {% endblock %}
        </main>
    </div>
</div>

<!-- base script -->
<script src="{{ url_for('static', filename='js/base.js') }}"></script>

<!-- updated script to fetch home stats with better error handling -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadHomeStats();
        loadRecentActivities(); // Load recent activities
    });

    function loadHomeStats() {
        console.log("[v0] Starting loadHomeStats function");
        
        const totalLeadsEl = document.getElementById('totalLeadsValue');
        const conversionRateEl = document.getElementById('conversionRateValue');
        const activeDealsEl = document.getElementById('activeDealsValue');
        
        console.log("[v0] Elements found:", {
            totalLeads: !!totalLeadsEl,
            conversion: !!conversionRateEl,
            activeDeals: !!activeDealsEl
        });
        
        fetch('/api/home-stats', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            console.log("[v0] Response status:", response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("[v0] Data received:", data);
            
            if (data.success && data.stats) {
                const stats = data.stats;
                console.log("[v0] Stats object:", {
                    total_leads: stats.total_leads,
                    conversion_rate: stats.conversion_rate,
                    active_deals: stats.active_deals
                });
                
                // Update Total Leads
                if (totalLeadsEl) {
                    const formattedLeads = stats.total_leads.toLocaleString();
                    totalLeadsEl.textContent = formattedLeads;
                    console.log("[v0] Updated Total Leads to:", formattedLeads);
                }
                
                // Update Conversion Rate
                if (conversionRateEl) {
                    const formattedRate = stats.conversion_rate + '%';
                    conversionRateEl.textContent = formattedRate;
                    console.log("[v0] Updated Conversion Rate to:", formattedRate);
                }
                
                // Update Active Deals
                if (activeDealsEl) {
                    const formattedDeals = stats.active_deals.toLocaleString();
                    activeDealsEl.textContent = formattedDeals;
                    console.log("[v0] Updated Active Deals to:", formattedDeals);
                }
            } else {
                console.warn("[v0] Response data missing success or stats:", data);
            }
        })
        .catch(error => {
            console.error("[v0] Error loading home stats:", error.message);
            console.error("[v0] Full error:", error);
        });
    }

    function loadRecentActivities() {
        console.log("[v0] Starting loadRecentActivities function");
        
        const timelineEl = document.getElementById('activityTimeline');
        if (!timelineEl) {
            console.warn("[v0] Activity timeline element not found");
            return;
        }
        
        fetch('/api/home-activities?limit=5', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            console.log("[v0] Activities response status:", response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("[v0] Activities data received:", data);
            
            if (data.success && data.activities && data.activities.length > 0) {
                timelineEl.innerHTML = '';
                
                data.activities.forEach(activity => {
                    const timelineItem = createActivityTimelineItem(activity);
                    timelineEl.appendChild(timelineItem);
                });
            } else {
                timelineEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No recent activities</div>';
            }
        })
        .catch(error => {
            console.error("[v0] Error loading activities:", error.message);
            timelineEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #ff6b6b;">Error loading activities</div>';
        });
    }

    function createActivityTimelineItem(activity) {
        const item = document.createElement('div');
        item.className = 'timeline-item';
        
        // Determine icon based on activity type
        let iconColor = '#dbeafe';
        let iconColorText = '#2563eb';
        let iconSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>';
        
        if (activity.activityType === 'stage_change') {
            iconColor = '#fef3c7';
            iconColorText = '#d97706';
            iconSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>';
        } else if (activity.activityType === 'call') {
            iconColor = '#e0e7ff';
            iconColorText = '#6366f1';
            iconSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>';
        } else if (activity.activityType === 'assigned') {
            iconColor = '#dcfce7';
            iconColorText = '#16a34a';
            iconSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22,6 12,14 2,6"></polyline></svg>';
        }
        
        // Format date/time
        const date = new Date(activity.createdAt);
        const now = new Date();
        let timeString = '';
        
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) {
            timeString = 'Just now';
        } else if (diffMins < 60) {
            timeString = `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
        } else if (diffHours < 24) {
            timeString = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        } else if (diffDays < 7) {
            timeString = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        } else {
            timeString = date.toLocaleDateString();
        }
        
        item.innerHTML = `
            <div class="timeline-icon" style="background: ${iconColor}; color: ${iconColorText};">
                ${iconSvg}
            </div>
            <div class="timeline-content">
                <div class="timeline-title">${activity.description}</div>
                <div class="timeline-meta">${activity.performedByName} â€¢ ${timeString}</div>
            </div>
        `;
        
        return item;
    }

    function toggleNotificationDropdown() {
        const dropdownEl = document.getElementById('notificationDropdown');
        if (dropdownEl.style.display === 'none') {
            dropdownEl.style.display = 'block';
        } else {
            dropdownEl.style.display = 'none';
        }
    }

    function logout() {
        window.location.href = '/logout';
    }
</script>

<!-- per-page extra JS if needed -->
{% block extra_js %}{% endblock %}

</body>
</html>
